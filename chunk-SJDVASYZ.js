import{$c as E,R as b,S as m,T as u,Z as y,Zc as I,_c as D,ca as P,fa as S,ga as R,la as w,ua as A}from"./chunk-FEC2V4R3.js";import{Y as p,Zc as h,ba as n,o as c,ta as o,va as f}from"./chunk-EG5ORV3B.js";import{a as v,b as g}from"./chunk-VB56BUGO.js";var M={details:{label:"Details"},assets:{label:"Assets",permissions:"client:list-assets"},geofences:{label:"Geofences",permissions:"client:list-zones"},alerts:{label:"Alerts",permissions:{or:["client:alerts","client:list-alerts"]}},hardware:{label:"Hardware",permissions:{or:["client:list-devices","client:devices","client:list-assettags","client:assettags","client:list-simcards","client:simcards"]}},"client-hardware-devices":{label:"Devices",permissions:{or:["client:list-devices","client:devices"]}},"client-asset-tags":{label:"Asset Tags",permissions:{or:["client:list-assettags","client:assettags"]}},"client-sim-cards":{label:"Sim Cards",permissions:{or:["client:list-simcards","client:simcards"]}},providers:{label:"Providers",permissions:{or:["client:list-smsGatewayProviders","client:smsGatewayProviders","client:list-smsgateways","client:smsgateways"]}},"client-sms-gateway-providers":{label:"SMS Gateways",permissions:{or:["client:list-smsGatewayProviders","client:smsGatewayProviders","client:list-smsgateways","client:smsgateways"]}},profiles:{label:"Profiles",permissions:{or:["client:list-iotypes","client:iotypes","client:list-deviceconfigprofiles","client:deviceconfigprofiles","client:list-assetratingprofiles","client:assetratingprofiles","client:list-assetstateprofiles","client:assetstateprofiles","client:list-overspeedprofiles","client:overspeedprofiles","client:list-roadprofiles","client:roadprofiles","client:list-geolockprofiles","client:geolockprofiles","client:list-customfields","client:customfields"]}},"client-io-types":{label:"I/O Types",permissions:{or:["client:list-iotypes","client:iotypes"]}},"client-device-config-profiles":{label:"Device Config Profiles",permissions:{or:["client:list-deviceconfigprofiles","client:deviceconfigprofiles"]}},"client-asset-rating-profiles":{label:"Asset Rating Profiles",permissions:{or:["client:list-assetratingprofiles","client:assetratingprofiles"]}},"client-asset-state-profiles":{label:"Asset State Profiles",permissions:{or:["client:list-assetstateprofiles","client:assetstateprofiles"]}},"client-overspeed-profiles":{label:"Overspeed Profiles",permissions:{or:["client:list-overspeedprofiles","client:overspeedprofiles"]}},"client-road-profiles":{label:"Road Profiles",permissions:{or:["client:list-roadprofiles","client:roadprofiles"]}},"client-geo-lock-profiles":{label:"Geo Lock Profiles",permissions:{or:["client:list-geolockprofiles","client:geolockprofiles"]}},"client-custom-fields":{label:"Custom Fields",permissions:{or:["client:list-customfields","client:customfields"]}},organization:{label:"Organization",permissions:{or:["client:list-costcentres","client:costcentres","client:list-assetgroups","client:assetgroups","client:list-assetcategories","client:assetcategories","client:list-zonegroups","client:zonegroups"]}},"client-cost-centres":{label:"Cost Centres",permissions:{or:["client:list-costcentres","client:costcentres"]}},"client-asset-groups":{label:"Asset Groups",permissions:{or:["client:list-assetgroups","client:assetgroups"]}},"client-asset-categories":{label:"Categories",permissions:{or:["client:list-assetcategories","client:assetcategories"]}},"client-geofence-groups":{label:"Geofence Groups",permissions:{or:["client:list-zonegroups","client:zonegroups"]}},accounts:{label:"Accounts",permissions:{or:["client:list-users","client:users","client:list-userroles","client:userroles"]}},"client-users":{label:"Users",permissions:{or:["client:list-users","client:users"]}},"client-user-roles":{label:"User Roles",permissions:{or:["client:list-userroles","client:userroles"]}}};var N=class a{authData=n(D);accountsService=n(P);authService=n(S);distributorsService=n(w);vendorsService=n(A);clientsService=n(R);PERSONA_STORAGE_KEY="cv_qa_test_persona";testMode=o(!1);activePersona=o(null);availableRoles=o([]);isLoadingRoles=o(!1);manualOverrides=o(new Set);selectedDistributorId=o(null);selectedVendorId=o(null);selectedClientId=o(null);availableDistributors=o([]);availableVendors=o([]);availableClients=o([]);activeProfileName=h(()=>this.activePersona()?.name??"Real User");constructor(){this.isQAToolsAvailable()?this.restoreFromStorage():localStorage.removeItem(this.PERSONA_STORAGE_KEY),f(()=>{if(!this.isQAToolsAvailable()){this.authData.resetOverrides();return}let e=this.activePersona(),s=this.manualOverrides();if(this.testMode()){let t=new Set(e?.permissions??[]);s.forEach(i=>t.add(i));let r=e?{id:e.ownerId,type:e.ownerType}:void 0;this.authData.overridePermissions([...t],r)}else this.authData.resetOverrides()})}isQAToolsAvailable(){return b.production?this.authData.getUserProfile()?.emailAddress?.endsWith("@keytelematics.com")??!1:!0}resetQAState(){this.testMode.set(!1),this.activePersona.set(null),this.manualOverrides.set(new Set),this.selectedDistributorId.set(null),this.selectedVendorId.set(null),this.selectedClientId.set(null),this.availableDistributors.set([]),this.availableVendors.set([]),this.availableClients.set([]),localStorage.removeItem(this.PERSONA_STORAGE_KEY),this.authData.resetOverrides()}async loadAvailableRoles(){let e=this.authData.getUserProfile();if(!m(e?.owner?.id)){this.isLoadingRoles.set(!0);try{let s=await c(this.accountsService.listUserRoles(e.owner.id));this.availableRoles.set(s.items??[])}catch(s){console.error("Failed to load QA roles:",s)}finally{this.isLoadingRoles.set(!1)}}}async applyRole(e){let s=this.authData.getUserProfile();if(!m(s?.owner?.id))try{let t=await c(this.accountsService.getUserRole(e)),i=e==="00000000-0000-0000-0000-000000000000"?["system:all"]:this.extractPermissionsFromLegacyRights(t.legacyRights),l={id:e,name:t.name??"Unknown Role",permissions:i,ownerId:s.owner.id,ownerType:s.owner.type??null};this.activePersona.set(l),this.testMode.set(!0),this.saveToStorage(l)}catch(t){throw console.error("Failed to apply role:",t),t}}setPermissionOverride(e,s){let t=new Set(this.manualOverrides()),r=this.activePersona();if(s)t.add(e);else if(t.delete(e),r){let i=I.getInternalMappings(e),l=r.permissions.filter(d=>!i.includes(d));l.length!==r.permissions.length&&this.activePersona.set(g(v({},r),{permissions:l}))}this.manualOverrides.set(t),this.testMode()||this.testMode.set(!0)}extractPermissionsFromLegacyRights(e){if(m(e))return[];let s=[];for(let t in e)if(Object.hasOwn(e,t)){let r=e[t];if(Array.isArray(r)){let i=this.normalizeResourceName(t);for(let l of r)s.push(`${i}:${l}`)}}return[...new Set(s)]}normalizeResourceName(e){let s=e.toLowerCase().replaceAll("-","");return{vendors:"vendor",clients:"client",users:"user",userroles:"userrole",themes:"theme",mapsets:"mapset",assets:"asset",devices:"device",simcards:"simcard",zones:"zone",alerts:"alert"}[s]??s}denormalizePermissions(e){let s={},t={vendor:"vendors",client:"clients",user:"users",userrole:"userroles",theme:"themes",mapset:"mapsets",asset:"assets",device:"devices",simcard:"simcards",zone:"zones",alert:"alerts"};return e.forEach(r=>{if(r==="system:all")return;let[i,l]=r.split(":");if(!i||!l)return;let d=t[i]??i;y(s[d])&&(s[d]=[]),s[d].push(l)}),s}async loadDistributors(){let e=this.authData.getRealUserOwnerId();if(!m(e))try{let s=await c(this.distributorsService.listDistributors(e));this.availableDistributors.set(s.items??[])}catch(s){console.error("Error loading distributors:",s),this.availableDistributors.set([])}}async loadVendors(e){try{let s=await c(this.vendorsService.listVendors(e));this.availableVendors.set(s.items??[])}catch(s){console.error("Error loading vendors:",s),this.availableVendors.set([])}}async loadClients(e){try{let s=await c(this.clientsService.listClients(e));this.availableClients.set(s.items??[])}catch(s){console.error("Error loading clients:",s),this.availableClients.set([])}}selectDistributor(e){this.selectedDistributorId.set(e),this.selectedVendorId.set(null),this.selectedClientId.set(null),this.availableVendors.set([]),this.availableClients.set([]),u(e)&&this.loadVendors(e).catch(()=>{})}selectVendor(e){this.selectedVendorId.set(e),this.selectedClientId.set(null),this.availableClients.set([]),u(e)&&this.loadClients(e).catch(()=>{})}selectClient(e){this.selectedClientId.set(e)}async saveCurrentOverridesToRole(){let e=this.activePersona();if(!e)return;let s=this.manualOverrides(),t=new Set(e.permissions);s.forEach(i=>t.add(i));let r=this.denormalizePermissions([...t]);try{await c(this.accountsService.updateUserRole(e.id,{name:e.name,legacyRights:r}))}catch(i){throw console.error("Failed to save overridden permissions to role:",i),i}}saveToStorage(e){localStorage.setItem(this.PERSONA_STORAGE_KEY,JSON.stringify(e))}restoreFromStorage(){let e=localStorage.getItem(this.PERSONA_STORAGE_KEY);if(e!=null)try{let s=JSON.parse(e);this.activePersona.set(s),this.testMode.set(!0)}catch(s){console.error("QA Tools: Error restoring persona from storage:",s),localStorage.removeItem(this.PERSONA_STORAGE_KEY)}}static \u0275fac=function(s){return new(s||a)};static \u0275prov=p({token:a,factory:a.\u0275fac,providedIn:"root"})};var O=class a{permissionService=n(E);canAccessFeature(e){return e==null?!0:this.permissionService.canAccess(e,"client")}static \u0275fac=function(s){return new(s||a)};static \u0275prov=p({token:a,factory:a.\u0275fac,providedIn:"root"})};export{N as a,O as b,M as c};
