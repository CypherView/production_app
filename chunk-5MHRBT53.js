import{a as F}from"./chunk-2MGCTFZV.js";import{ja as m,ma as S}from"./chunk-ZDWK5NB6.js";import{J as T,K as E,M as p,Pc as d,S as v,T as c,Wc as x,c as I}from"./chunk-FEC2V4R3.js";import{D,H as R,Y as l,ba as s,d as U,na as b,ta as h}from"./chunk-EG5ORV3B.js";import{a as n}from"./chunk-VB56BUGO.js";var u=class a{router=s(p);config={routeDepth:3};configure(e){this.config=n(n({},this.config),e)}getBaseRoute(e){let t=e.split("?")[0],i=/^(\/[^/]+\/[^/]+\/[^/]+)/.exec(t);return i?i[1]:t}isSameParentRoute(e,t){let r=this.config.routeDepth,i=`^(${"/[^/]+".repeat(r)})`,o=new RegExp(i),f=e?o.exec(e)?.[1]:void 0,k=t?o.exec(t)?.[1]:void 0;return f===k}getGridTypeFromUrl(e=this.router.url){let t=[{regex:/\/hardware\/([^/?]+)/,groupIndex:1},{regex:/\/profiles\/([^/?]+)/,groupIndex:1},{regex:/\/providers\/([^/?]+)/,groupIndex:1},{regex:/\/([^/]+)\/([^/?]+)$/,groupIndex:2}];for(let r of t){let i=e.match(r.regex);if(i&&i.length>r.groupIndex)return i[r.groupIndex]}return""}extractEntityDetailsFromUrl(e,t={id:"details",type:"type"}){return{id:e[t.id],type:e[t.type]}}isEntityDetailsUrl(e,t={id:"details",type:"type"}){let r=new URLSearchParams(e.split("?")[1]||"");return r.has(t.id)&&r.has(t.type)}static \u0275fac=function(t){return new(t||a)};static \u0275prov=l({token:a,factory:a.\u0275fac,providedIn:"root"})};var g=class a{router=s(p);location=s(I);urlParser=s(u);config={paramNames:{id:"details",type:"type"}};configure(e){this.config=n(n({},this.config),e)}async updateUrlForDetails(e){try{if(v(e)||v(e.id))return;let t=this.router.url,[r,i]=t.split("?"),o=new URLSearchParams(i||"");o.set(this.config.paramNames.id,String(e.id)),o.set(this.config.paramNames.type,e.entityType?.toString()??this.urlParser.getGridTypeFromUrl(this.router.url)),this.location.replaceState(r,o.toString())}catch(t){console.error("Error updating URL for details:",t)}}cleanUpUrlParams(){let t=this.router.url.split("?"),r=t[0],i=new URLSearchParams(t[1]||"");i.delete(this.config.paramNames.id),i.delete(this.config.paramNames.type);let o=i.toString(),f=o?`${r}?${o}`:r;this.location.replaceState(f)}generateEntityDetailsUrl(e,t,r){let i=new URLSearchParams;return i.set(this.config.paramNames.id,t),i.set(this.config.paramNames.type,r),`${e}?${i.toString()}`}hasEntityDetailsParams(e){return!!(e[this.config.paramNames.id]&&e[this.config.paramNames.type])}static \u0275fac=function(t){return new(t||a)};static \u0275prov=l({token:a,factory:a.\u0275fac,providedIn:"root"})};var y=class a{router=s(p);activatedRoute=s(E);stateService=s(m);loaderService=s(F);broadcastService=s(x);destroyRef=s(b);urlParser=s(u);urlManager=s(g);urlCheckSubject=new U;currentGridType=h(null);currentRoute=h("");initialized=h(!1);config={paramNames:{id:"details",type:"type"},processingDelay:100};constructor(){this.broadcastService.on("entity-deleted").pipe(d(this.destroyRef)).subscribe(()=>{this.urlManager.cleanUpUrlParams()})}configure(e){this.config=n(n({},this.config),e),this.urlManager.configure({paramNames:this.config.paramNames}),this.urlParser.configure({routeDepth:3})}initialize(){this.urlCheckSubject.pipe(R(this.config.processingDelay),d(this.destroyRef)).subscribe(()=>{this.processUrlCheck()}),this.currentRoute.set(this.urlParser.getBaseRoute(this.router.url)),this.currentGridType.set(this.urlParser.getGridTypeFromUrl()),this.initialized.set(!0),this.checkUrlForDetailsPanel(),this.setupBroadcastListener(),this.setupRouteListeners(),this.router.url.includes("?")&&this.checkUrlForDetailsPanel()}setupBroadcastListener(){this.broadcastService.on("grid-item-selected").pipe(d(this.destroyRef)).subscribe(e=>{c(e.item)&&c(e.item.id)&&c(e.item.entityType)?(this.stateService.isLoading.set(!0),this.loaderService.loadEntityDetails(String(e.item.entityType),String(e.item.id))):this.stateService.openDetailsPanel(e.item,e.componentType??S),this.urlManager.updateUrlForDetails(e.item).catch(()=>{})}),this.broadcastService.on("tree-item-selected").pipe(d(this.destroyRef)).subscribe(e=>{c(e.item)&&c(e.item.id)&&c(e.item.entityType)?(this.stateService.isLoading.set(!0),this.loaderService.loadEntityDetails(String(e.item.entityType),String(e.item.id))):this.stateService.openDetailsPanel(e.item,e.componentType??S),this.urlManager.updateUrlForDetails(e.item).catch(()=>{})})}setupRouteListeners(){let e=this.router.url;this.router.events.pipe(D(t=>t instanceof T),d(this.destroyRef)).subscribe(t=>{let r=t.url;this.handleRouteChange(e,r);let i=this.urlParser.getGridTypeFromUrl();this.currentGridType()!==null&&this.currentGridType()!==i&&!this.urlParser.isSameParentRoute(this.currentRoute(),this.router.url)&&this.stateService.showPanel()&&this.closeDetailsPanel(),this.currentGridType.set(i),this.currentRoute.set(this.urlParser.getBaseRoute(this.router.url)),this.checkUrlForDetailsPanel(),e=r})}checkUrlForDetailsPanel(){this.urlCheckSubject.next()}processUrlCheck(){try{let e=this.activatedRoute.snapshot.queryParams,t=e[this.config.paramNames.id],r=e[this.config.paramNames.type];c(t)&&c(r)?this.loaderService.loadEntityDetails(r,t):this.stateService.showPanel()&&this.initialized()&&this.closeDetailsPanel()}catch(e){console.error("Error checking URL for details panel:",e)}}async updateUrlForDetails(e){return this.urlManager.updateUrlForDetails(e)}closeDetailsPanel(){this.stateService.showPanel()&&(this.urlManager.cleanUpUrlParams(),this.stateService.closeDetailsPanel(),this.broadcastService.broadcast("details-panel-closed",{reason:"panel closed"}))}handleRouteChange(e,t){let r=this.urlParser.getBaseRoute(e),i=this.urlParser.getBaseRoute(t);r===i?this.checkUrlForDetailsPanel():this.closeDetailsPanel()}syncDetailsStateWithUrl(){let e=this.router.url,t=this.stateService.selectedItem();this.stateService.showPanel()&&t?(!e.includes("details=")||!e.includes("type="))&&this.updateUrlForDetails(t).catch(()=>{}):this.stateService.showPanel()||(e.includes("details=")||e.includes("type="))&&this.closeDetailsPanel()}static \u0275fac=function(t){return new(t||a)};static \u0275prov=l({token:a,factory:a.\u0275fac,providedIn:"root"})};var w=class a{stateService=s(m);urlService=s(y);showPanel=this.stateService.showPanel;selectedItem=this.stateService.selectedItem;detailsComponent=this.stateService.detailsComponent;detailsInputs=this.stateService.detailsInputs;isLoading=this.stateService.isLoading;isSoftRefreshing=this.stateService.isSoftRefreshing;constructor(){this.urlService.initialize()}openDetailsPanel(e,t){this.stateService.openDetailsPanel(e,t),this.urlService.updateUrlForDetails(e).catch(()=>{})}closeDetailsPanel(){this.urlService.closeDetailsPanel()}getSelectedItemTitle(){return this.stateService.getSelectedItemTitle()}getSelectedItemType(){return this.stateService.getSelectedItemType()}getSelectedItemId(){return this.stateService.getSelectedItemId()}softRefreshSelectedItem(e){this.stateService.softRefreshSelectedItem(e)}syncDetailsStateWithUrl(){this.urlService.syncDetailsStateWithUrl()}static \u0275fac=function(t){return new(t||a)};static \u0275prov=l({token:a,factory:a.\u0275fac,providedIn:"root"})};export{w as a};
