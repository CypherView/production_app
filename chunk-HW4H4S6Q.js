import{I as c,R as f,Xc as h}from"./chunk-FEC2V4R3.js";import{Ua as u,Vb as p,_b as m,a as n,ba as r,mb as d,qa as l,z as o}from"./chunk-EG5ORV3B.js";import"./chunk-VB56BUGO.js";var T=class a{sanitizer=r(c);messageService=r(h);ngZone=r(l);safeUrl;flutterLoaded=!1;subscription=new n;initializationAttempts=0;MAX_INITIALIZATION_ATTEMPTS=5;RETRY_DELAY=2e3;constructor(){this.safeUrl=this.sanitizer.bypassSecurityTrustResourceUrl(f.flutterUrl)}ngOnInit(){window.addEventListener("message",this.handleIframeLoad.bind(this));let e=0;this.subscription.add(this.messageService.messages$.subscribe(t=>{let s=t.filter(i=>i.type==="action"&&i.action==="ready"&&i.sender==="flutter");if(s.length>0){let i=s[s.length-1];i.timestamp&&i.timestamp>e&&(e=i.timestamp,this.flutterLoaded=!0,this.initializationAttempts=0,this.sendAuthTokensToFlutter())}})),this.subscription.add(this.messageService.connectionStatus$.subscribe(t=>{t.isConnected?this.flutterLoaded||(this.flutterLoaded=!0,this.initializationAttempts=0,this.ngZone.runOutsideAngular(()=>{setTimeout(()=>{this.ngZone.run(()=>{this.messageService.sendAuthTokensToFlutter()})},500)})):this.flutterLoaded=!1})),this.setupFallbackTimer()}ngOnDestroy(){window.removeEventListener("message",this.handleIframeLoad.bind(this)),this.subscription.unsubscribe()}handleIframeLoad(e){if(!(e.data===null||e.data===void 0))switch(e.data.type){case"flutter-initialized":this.flutterLoaded=!0,this.initializationAttempts=0,this.sendAuthTokensToFlutter();break;case"flutter-request-tokens":this.sendAuthTokensToFlutter(0);break;case"flutter-keep-alive":console.debug("Received keep-alive from Flutter",e.data.timestamp),this.flutterLoaded||(this.flutterLoaded=!0,this.initializationAttempts=0,this.sendAuthTokensToFlutter());break}}sendAuthTokensToFlutter(e=500){this.ngZone.runOutsideAngular(()=>{setTimeout(()=>{this.ngZone.run(()=>{this.messageService.sendAuthTokensToFlutter()})},e)})}setupFallbackTimer(){let e=o(5e3,this.RETRY_DELAY).subscribe(()=>{if(this.initializationAttempts>=this.MAX_INITIALIZATION_ATTEMPTS){e.unsubscribe();return}this.flutterLoaded?e.unsubscribe():(this.messageService.sendAuthTokensToFlutter(),this.initializationAttempts++)});this.subscription.add(e)}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=d({type:a,selectors:[["app-flutter-layout"]],decls:1,vars:1,consts:[["id","flutter-app","title","Embedded Flutter Application","allow","same-origin; scripts; fullscreen","sandbox","allow-scripts allow-same-origin allow-forms allow-popups allow-downloads",1,"flutter-app-iframe",3,"src"]],template:function(t,s){t&1&&p(0,"iframe",0),t&2&&m("src",s.safeUrl,u)},styles:[".flutter-app-iframe[_ngcontent-%COMP%]{width:100%;height:100%;border:none;display:block}"]})};export{T as FlutterLayoutComponent};
